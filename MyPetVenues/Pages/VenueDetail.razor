@page "/venues/{VenueId:int}"
@inject IVenueService VenueService
@inject IUserService UserService
@inject NavigationManager Navigation

<div class="venue-detail-page">
    @if (venue == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="venue-hero">
            <img src="@venue.ImageUrl" alt="@venue.Name" class="hero-image" />
            <div class="hero-overlay">
                <VenueTypeBadge Type="@venue.Type" />
            </div>
        </div>

        <div class="venue-header">
            <div class="header-content">
                <h1>@venue.Name</h1>
                <p class="venue-location">üìç @venue.Address, @venue.City</p>
                <div class="rating-row">
                    <StarRating Rating="@venue.Rating" />
                    <span class="review-count">(@venue.ReviewCount reviews)</span>
                    <button class="favorite-btn @(isFavorite ? "active" : "")" @onclick="ToggleFavorite">
                        @(isFavorite ? "‚ù§Ô∏è" : "ü§ç")
                    </button>
                </div>
            </div>
            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo($"/booking?venue={venue.Id}")'>
                Book This Venue
            </button>
        </div>

        <div class="venue-content">
            <div class="main-column">
                <section class="section">
                    <h2>About</h2>
                    <p>@venue.Description</p>
                </section>

                <section class="section">
                    <h2>Allowed Pets</h2>
                    <div class="pets-list">
                        @foreach (var pet in venue.AllowedPets)
                        {
                            <PetBadge Type="@pet" />
                        }
                    </div>
                </section>

                <section class="section">
                    <h2>Amenities</h2>
                    <div class="amenities-grid">
                        @foreach (var amenity in venue.Amenities)
                        {
                            <AmenityTag Amenity="@amenity" />
                        }
                    </div>
                </section>

                <section class="section">
                    <h2>Reviews</h2>
                    @if (reviews == null)
                    {
                        <p>Loading reviews...</p>
                    }
                    else if (!reviews.Any())
                    {
                        <p>No reviews yet. Be the first to review!</p>
                    }
                    else
                    {
                        <div class="reviews-list">
                            @foreach (var review in reviews)
                            {
                                <ReviewCard Review="@review" />
                            }
                        </div>
                    }
                </section>
            </div>

            <aside class="sidebar">
                <div class="sidebar-card">
                    <h3>Opening Hours</h3>
                    <div class="hours-list">
                        @foreach (var (day, hours) in venue.OpeningHours)
                        {
                            <div class="hours-row">
                                <span class="day">@day</span>
                                <span class="hours">@hours</span>
                            </div>
                        }
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3>Contact</h3>
                    <p>üìû @venue.ContactPhone</p>
                    @if (!string.IsNullOrEmpty(venue.Website))
                    {
                        <p>üåê <a href="@venue.Website" target="_blank">Visit Website</a></p>
                    }
                </div>
            </aside>
        </div>
    }
</div>

@code {
    [Parameter] public int VenueId { get; set; }

    private Venue? venue;
    private List<Review>? reviews;
    private bool isFavorite;

    protected override async Task OnInitializedAsync()
    {
        venue = await VenueService.GetVenueByIdAsync(VenueId);
        reviews = await VenueService.GetVenueReviewsAsync(VenueId);
        
        var user = await UserService.GetCurrentUserAsync();
        isFavorite = user.FavoriteVenueIds.Contains(VenueId);
    }

    private async Task ToggleFavorite()
    {
        if (isFavorite)
        {
            await UserService.RemoveFavoriteVenueAsync(VenueId);
        }
        else
        {
            await UserService.AddFavoriteVenueAsync(VenueId);
        }
        isFavorite = !isFavorite;
    }
}
