@page "/venues"
@inject IVenueService VenueService
@inject NavigationManager Navigation

<div class="venues-page">
    <header class="page-header">
        <h1>Explore Pet-Friendly Venues</h1>
        <p>Find the perfect spot for you and your pets</p>
    </header>

    <SearchFilters SearchTerm="@searchTerm" 
                   SelectedVenueType="@selectedType" 
                   SelectedPetType="@selectedPet"
                   OnSearch="HandleSearch" />

    @if (filteredVenues == null)
    {
        <div class="loading-state">
            <p>Loading venues...</p>
        </div>
    }
    else if (!filteredVenues.Any())
    {
        <div class="empty-state">
            <span class="empty-icon">üîç</span>
            <h2>No venues found</h2>
            <p>Try adjusting your search filters</p>
        </div>
    }
    else
    {
        <div class="results-header">
            <p>Found <strong>@filteredVenues.Count</strong> venues</p>
        </div>

        <div class="venues-grid">
            @foreach (var venue in filteredVenues)
            {
                <VenueCard Venue="@venue" 
                          IsFeatured="@venue.IsFeatured" 
                          OnClick='() => Navigation.NavigateTo($"/venues/{venue.Id}")' />
            }
        </div>
    }
</div>

@code {
    private List<Venue>? filteredVenues;
    private string? searchTerm;
    private VenueType? selectedType;
    private PetType? selectedPet;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        searchTerm = query["search"];
        selectedType = Enum.TryParse<VenueType>(query["type"], out var type) ? type : null;
        selectedPet = Enum.TryParse<PetType>(query["pet"], out var pet) ? pet : null;

        await LoadVenues();
    }

    private async Task HandleSearch((string?, VenueType?, PetType?) filters)
    {
        (searchTerm, selectedType, selectedPet) = filters;
        await LoadVenues();
    }

    private async Task LoadVenues()
    {
        filteredVenues = await VenueService.SearchVenuesAsync(searchTerm, selectedType, selectedPet);
    }
}
