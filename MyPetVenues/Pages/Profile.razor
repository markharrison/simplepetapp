@page "/profile"
@inject IUserService UserService
@inject IVenueService VenueService
@inject NavigationManager Navigation

<div class="profile-page">
    @if (user == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="profile-header">
            <img src="@user.ProfileImageUrl" alt="@user.Name" class="profile-avatar" />
            <div class="profile-info">
                <h1>@user.Name</h1>
                <p class="profile-email">@user.Email</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab @(activeTab == "pets" ? "active" : "")" @onclick='() => SetTab("pets")'>
                ðŸ¾ My Pets
            </button>
            <button class="tab @(activeTab == "favorites" ? "active" : "")" @onclick='() => SetTab("favorites")'>
                â¤ï¸ Favorites
            </button>
            <button class="tab @(activeTab == "bookings" ? "active" : "")" @onclick='() => SetTab("bookings")'>
                ðŸ“… Bookings
            </button>
            <button class="tab @(activeTab == "settings" ? "active" : "")" @onclick='() => SetTab("settings")'>
                âš™ï¸ Settings
            </button>
        </div>

        <div class="tab-content">
            @if (activeTab == "pets")
            {
                <div class="pets-grid">
                    @foreach (var pet in user.Pets)
                    {
                        <div class="pet-card">
                            <img src="@pet.ImageUrl" alt="@pet.Name" class="pet-image" />
                            <h3>@pet.Name</h3>
                            <PetBadge Type="@pet.Type" />
                            <p>@pet.Breed</p>
                            <p>@pet.Age years old</p>
                        </div>
                    }
                    <div class="pet-card add-pet-card">
                        <span class="add-icon">âž•</span>
                        <p>Add New Pet</p>
                    </div>
                </div>
            }
            else if (activeTab == "favorites")
            {
                @if (favoriteVenues == null)
                {
                    <p>Loading favorites...</p>
                }
                else if (!favoriteVenues.Any())
                {
                    <div class="empty-state">
                        <span class="empty-icon">â¤ï¸</span>
                        <p>No favorite venues yet</p>
                        <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/venues")'>
                            Explore Venues
                        </button>
                    </div>
                }
                else
                {
                    <div class="favorites-grid">
                        @foreach (var venue in favoriteVenues)
                        {
                            <VenueCard Venue="@venue" OnClick='() => Navigation.NavigateTo($"/venues/{venue.Id}")' />
                        }
                    </div>
                }
            }
            else if (activeTab == "bookings")
            {
                @if (user.Bookings == null || !user.Bookings.Any())
                {
                    <div class="empty-state">
                        <span class="empty-icon">ðŸ“…</span>
                        <p>No bookings yet</p>
                        <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/booking")'>
                            Make a Booking
                        </button>
                    </div>
                }
                else
                {
                    <div class="bookings-list">
                        @foreach (var booking in user.Bookings.OrderByDescending(b => b.BookingDate))
                        {
                            <div class="booking-card">
                                <div class="booking-header">
                                    <h3>Booking #@booking.Id</h3>
                                    <span class="status-badge status-@booking.Status.ToString().ToLower()">
                                        @booking.Status
                                    </span>
                                </div>
                                <p>ðŸ“ Venue ID: @booking.VenueId</p>
                                <p>ðŸ“… @booking.BookingDate.ToString("MMMM dd, yyyy")</p>
                                <p>â° @booking.TimeSlot</p>
                                <p>ðŸ¾ @booking.NumberOfPets pet(s)</p>
                                @if (!string.IsNullOrEmpty(booking.Notes))
                                {
                                    <p class="booking-notes">Notes: @booking.Notes</p>
                                }
                            </div>
                        }
                    </div>
                }
            }
            else if (activeTab == "settings")
            {
                <div class="settings-section">
                    <h2>Account Settings</h2>
                    <div class="setting-item">
                        <label>Email Notifications</label>
                        <input type="checkbox" checked />
                    </div>
                    <div class="setting-item">
                        <label>Dark Mode</label>
                        <input type="checkbox" />
                    </div>
                    <button class="btn btn-primary">Save Changes</button>
                </div>
            }
        </div>
    }
</div>

@code {
    private User? user;
    private List<Venue>? favoriteVenues;
    private string activeTab = "pets";

    protected override async Task OnInitializedAsync()
    {
        user = await UserService.GetCurrentUserAsync();
        await LoadFavorites();
    }

    private void SetTab(string tab)
    {
        activeTab = tab;
        if (tab == "favorites")
        {
            _ = LoadFavorites();
        }
    }

    private async Task LoadFavorites()
    {
        if (user != null && user.FavoriteVenueIds.Any())
        {
            var allVenues = await VenueService.GetVenuesAsync();
            favoriteVenues = allVenues.Where(v => user.FavoriteVenueIds.Contains(v.Id)).ToList();
        }
        else
        {
            favoriteVenues = new List<Venue>();
        }
    }
}
